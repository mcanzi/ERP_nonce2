---
title: "Experiment 2: Data modelling"
author: "Massimiliano Canzi | `massimiliano.canzi@uni-konstanz.de`"
date: "20/02/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, message = F}
library(car)
library(emmeans)
library(lme4)
library(lmerTest)
library(magrittr)
library(tidyverse)
```

```{r readr.1, message = FALSE}
ERP <- read_csv("../data/EXP2.lmer.csv") %>%
  filter(Cond == "target" | Cond == "control") %>%
  mutate(Subj = as.factor(Subj)) %>%
  # filter_if(~is.numeric(.), all_vars(!is.infinite(.))) %>%
  filter(time >= -100 & time <= 700) %>%
  gather(electrode, amplitude, Fp1:T8, factor_key = TRUE) %>%
  mutate(time = as.numeric(as.character(format(round(time, 0), nsmall = 0))),
         Block = as.factor(Block))

names(ERP) <- c("subject", "block", "condition", "time", "electrode", "amplitude")
```

```{r readr.2, message = FALSE}
ERP %<>% mutate(time = as.factor(time), subject = as.factor(subject)) %>%
  group_by(subject, block, condition, electrode, time) %>% 
  summarise(amplitude.mean = mean(amplitude),) %>% 
  ungroup() %>% mutate(time = as.numeric(as.character(time)), 
                       amplitude.mean = as.numeric(amplitude.mean), 
                       electrode = as.factor(electrode)) %>%
  filter(amplitude.mean <= 20 & amplitude.mean >= -20) %>%
  mutate(amplitude.mean = as.numeric(format(round(amplitude.mean, 2), nsmall = 2)))
```

__N__ = _1990_

```{r, summarised.model, message = F}
summarised.data <- function(TP1, TP2) {
  
  lmer.data <- left_join(ERP %>%
    filter(time >= TP1) %>%
    filter(time <= TP2) %>%
    filter(block == "ATT") %>%
    group_by(subject, block, condition, electrode) %>%
    summarise(amplitude = mean(amplitude.mean),) %>% ungroup,
    read.csv("../resources/lmer_electrodes.csv", 
                        sep = ";"), by = "electrode") %>% 
    filter(side != "none") %>% mutate_if(is.character, as.factor)

  return(lmer.data) }
```

## LMEM: 75-100 ms

```{r, message = F}
model.75.100 <- summarised.data(75, 100) %>% 
  lmer(formula = amplitude ~ condition * region + side + (1 | subject))
```

```{r, message = F}
isSingular(model.75.100)
Anova(model.75.100, type = "III")
emmeans(model.75.100, pairwise ~ condition | region)
summary(model.75.100)
```

## LMEM: 150-200 ms

```{r, message = F}
model.150.200.2 <- summarised.data(160, 210) %>% 
  lmer(formula = amplitude ~ condition * region + side + (1 | subject))

model.150.200 <- summarised.data(160, 210) %>% 
  lmer(formula = amplitude ~ region + condition * side + (1 | subject))

anova(model.150.200, model.150.200.2)
```

```{r, message = F}
isSingular(model.150.200)
Anova(model.150.200, type = "III")
emmeans(model.150.200, pairwise ~ condition | side)
summary(model.150.200)
```

## LMEM: 250-290 ms

```{r}
model.250.290 <- summarised.data(240, 280) %>% 
  lmer(formula = amplitude ~ condition * region * side + (1 | subject))

model.250.290.2 <- summarised.data(240, 280) %>% 
  lmer(formula = amplitude ~ condition * region + side + (1 | subject))

anova(model.250.290, model.250.290.2)
```

```{r, message = F}
isSingular(model.250.290)
Anova(model.250.290, type = "III")
emmeans(model.250.290, pairwise ~ condition | region)
summary(model.250.290)
```

## LM: 290-310 ms

```{r, message = F}
model.290.310.singular <- summarised.data(290, 310) %>% 
  lmer(formula = amplitude ~ condition * region * side + (1 | subject)) 

isSingular(model.290.310.singular)
```

```{r, message = F}
model.290.310 <- summarised.data(290, 310) %>% 
  lm(formula = amplitude ~ condition * region * side) 

model.290.310.2 <- summarised.data(290, 310) %>% 
  lm(formula = amplitude ~ condition * region + side) 

anova(model.290.310, model.290.310.2)
```

```{r, message = F}
Anova(model.290.310, type = "III")
emmeans(model.290.310, pairwise ~ condition | region * side)
summary(model.290.310)
```

## LM: 575-625 ms

```{r, message = F}
model.575.625.singular <- summarised.data(575, 625) %>% 
  lmer(formula = amplitude ~ condition * region * side + (1 | subject)) 

isSingular(model.575.625.singular)
```

```{r, message = F}
model.575.625 <- summarised.data(575, 625) %>% 
  lm(formula = amplitude ~ condition * region * side) 
```

```{r, message = F}
Anova(model.575.625, type = "III")
emmeans(model.575.625, pairwise ~ condition | region)
summary(model.575.625)
```
